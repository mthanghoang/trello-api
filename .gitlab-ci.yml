build:
    stage: build
    variables:
        GIT_STRATEGY: clone
    script:
        - yarn -DskipTests=true
        - yarn build
        - sudo mv build/ /data/trello-api
        - sudo mv node_modules/ /data/trello-api
    tags:
        - server
    
deploy:
    stage: deploy
    variables:
        GIT_STRATEGY: none
    when: manual
    before_script:
        - echo MONGODB_URI = ${MONGODB_URI} >> .env
        - echo DATABASE_NAME = ${DATABASE_NAME} >> .env
        - echo AUTHOR = ${AUTHOR} >> .env
        - echo PORT = ${PORT} >> .env
        - echo BUILD_MODE = ${BUILD_MODE} >> .env
    script:
        - sudo mv .env /data/trello-api/
        - sudo chown -r trello-api:trello-api /data/trello-api/
        - sudo chmod -r 750 /data/trello-api/
        - sudo su trello-api -c "nohup node ./build/src/server.js 2>&1 &"
    tags:
        - server
